<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bandwidth Hero - Tester</title>
    <style>
        :root { --bg: #121212; --text: #e0e0e0; --primary: #007bff; --card: #1e1e1e; --border: #333; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; display: flex; justify-content: center; padding: 2rem; }
        main { max-width: 900px; width: 100%; display: flex; flex-direction: column; gap: 2rem; }
        h1, h2 { text-align: center; }
        h1 { font-size: 2.5rem; color: var(--primary); }
        .card { background-color: var(--card); border-radius: 8px; padding: 1.5rem; border: 1px solid var(--border); }
        form { display: flex; gap: 1rem; }
        input[type="url"] { flex-grow: 1; padding: 0.75rem; border-radius: 4px; border: 1px solid var(--border); background-color: #2c2c2c; color: var(--text); font-size: 1rem; }
        button { padding: 0.75rem 1.5rem; background-color: var(--primary); color: white; border: none; border-radius: 4px; font-size: 1rem; cursor: pointer; transition: background-color 0.2s; }
        button:hover { background-color: #0056b3; }
        #results { display: none; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-top: 1.5rem; }
        .image-container { text-align: center; }
        img { max-width: 100%; border-radius: 4px; border: 1px solid var(--border); background-color: #2c2c2c;}
        .stats { font-size: 1.1rem; text-align: center; background: #2c2c2c; padding: 0.5rem; border-radius: 4px; }
        .stats strong { color: var(--primary); }
        #loader { text-align: center; font-size: 1.2rem; display: none; }
        .instructions input { width: 100%; box-sizing: border-box; background: #2c2c2c; color: #a0a0a0; padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border);}
    </style>
</head>
<body>
    <main>
        <h1>Bandwidth Hero SUPER ULTRA</h1>
        <div class="card">
            <h2>Prueba de Compresi칩n en Vivo</h2>
            <form id="compress-form">
                <input type="url" id="url-input" placeholder="Pega la URL de una imagen aqu칤..." required>
                <button type="submit">Comprimir</button>
            </form>
            <div id="loader">Comprimiendo, por favor espera... 游</div>
            <div id="results">
                <div class="image-container">
                    <h3>Original</h3>
                    <img id="original-img" src="" alt="Imagen Original">
                    <p class="stats" id="original-stats"></p>
                </div>
                <div class="image-container">
                    <h3>Comprimida</h3>
                    <img id="compressed-img" src="" alt="Imagen Comprimida">
                    <p class="stats" id="compressed-stats"></p>
                </div>
            </div>
        </div>
        <div class="card instructions">
            <h2>Uso con Tachiyomi</h2>
            <p>Copia esta URL y p칠gala en la configuraci칩n del servidor de la extensi칩n:</p>
            <input type="text" readonly onclick="this.select()" id="server-url">
        </div>
    </main>
<script>
    document.getElementById('server-url').value = window.location.origin;
    const form = document.getElementById('compress-form');
    const urlInput = document.getElementById('url-input');
    const loader = document.getElementById('loader');
    const resultsContainer = document.getElementById('results');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        loader.style.display = 'block';
        resultsContainer.style.display = 'none';

        const imageUrl = urlInput.value;
        const apiUrl = `/?url=${encodeURIComponent(imageUrl)}`;
        
        try {
            const response = await fetch(apiUrl);
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`Error del servidor (${response.status}): ${errorData.error}`);
            }

            const blob = await response.blob();
            const compressedUrl = URL.createObjectURL(blob);
            
            const originalSize = response.headers.get('X-Original-Size');
            const compressedSize = response.headers.get('X-Compressed-Size');

            displayResults(imageUrl, compressedUrl, originalSize, compressedSize);
        } catch (error) {
            alert(`Ha ocurrido un error: ${error.message}`);
        } finally {
            loader.style.display = 'none';
        }
    });

    function displayResults(originalUrl, compressedUrl, originalSize, compressedSize) {
        document.getElementById('original-img').src = originalUrl;
        document.getElementById('compressed-img').src = compressedUrl;

        const formatBytes = (bytes) => {
            if (!bytes || bytes === 0) return 'N/A';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        };

        const savings = 100 - (compressedSize / originalSize * 100);
        
        document.getElementById('original-stats').textContent = `Tama침o: ${formatBytes(originalSize)}`;
        document.getElementById('compressed-stats').innerHTML = `Tama침o: ${formatBytes(compressedSize)} <br><strong>Ahorro: ${savings.toFixed(1)}%</strong>`;
        
        resultsContainer.style.display = 'grid';
    }
</script>
</body>
</html>