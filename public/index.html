<!DOCTYPE html>
<html lang="es">
<head>
    <!-- ... la sección <head> y <style> se mantiene igual ... -->
</head>
<body>
    <main>
        <!-- ... la sección <main> se mantiene igual ... -->
    </main>
<script>
    document.getElementById('server-url').value = `${window.location.origin}/api/compress`;
    const form = document.getElementById('compress-form');
    const urlInput = document.getElementById('url-input');
    const loader = document.getElementById('loader');
    const resultsContainer = document.getElementById('results');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        loader.style.display = 'block';
        resultsContainer.style.display = 'none';

        const imageUrl = urlInput.value;
        const apiUrl = `/api/compress?url=${encodeURIComponent(imageUrl)}`;
        
        // --- MANEJO DE TIMEOUT EN EL CLIENTE ---
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 15000); // Timeout de 15 segundos en la UI

        try {
            const response = await fetch(apiUrl, { signal: controller.signal });
            clearTimeout(timeoutId); // Si la respuesta llega a tiempo, cancelamos el timeout

            if (response.status === 302) {
                throw new Error("El servidor de origen no respondió a tiempo. Se activó el fallback (redirección).");
            }

            if (!response.ok) {
                let errorMessage = `Error del servidor (${response.status})`;
                try {
                    const errorData = await response.json();
                    errorMessage += `: ${errorData.error || 'Error desconocido'}`;
                } catch (jsonError) {
                    errorMessage += `. Detalles: ${await response.text()}`;
                }
                throw new Error(errorMessage);
            }

            const blob = await response.blob();
            const compressedUrl = URL.createObjectURL(blob);
            
            const originalSize = response.headers.get('X-Original-Size');
            const compressedSize = response.headers.get('X-Compressed-Size');

            displayResults(imageUrl, compressedUrl, originalSize, compressedSize);
        } catch (error) {
            if (error.name === 'AbortError') {
                alert('Ha ocurrido un error: La petición tardó demasiado y fue cancelada (Timeout).');
            } else {
                alert(`Ha ocurrido un error: ${error.message}`);
            }
        } finally {
            loader.style.display = 'none';
        }
    });

    function displayResults(originalUrl, compressedUrl, originalSize, compressedSize) {
        // ... esta función se mantiene igual ...
    }
</script>
</body>
</html>
